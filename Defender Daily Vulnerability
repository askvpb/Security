// Initial data collection and transformation
DeviceTvmSoftwareVulnerabilities
| extend Timestamp = now()  // Sets current time as Timestamp
| extend ReportId = toint(rand() * 100000000)  // Generates a random Report ID
| extend OSFamily = case(
    OSPlatform in ("Windows10", "Windows11", "Windows10wVD"), "Desktop",
    OSPlatform in ("WindowsServer2012R2", "WindowsServer2016", "WindowsServer2019", "WindowsServer2022"), "Server",
    "Other")  // Categorizes OS into Desktop, Server, or Other
| where OSFamily != "Other"  // Filters out non-Desktop and non-Server entries
| where DeviceName !="" and DeviceName != " "  // Filters out devices with blank or space-only names
// Summarization by CVE ID
| summarize 
    DesktopDeviceNameList = make_list(iif(OSFamily == "Desktop", DeviceName, "")),  // Lists Device Names categorized as Desktops
    ServerDeviceNameList = make_list(iif(OSFamily == "Server", DeviceName, "")),  // Lists Device Names categorized as Servers
    DetailedDeviceList = make_list(bag_pack("DeviceName", DeviceName, "DeviceId", DeviceId, "OSPlatform", OSPlatform)),  // Packs detailed info into a list
    take_any(SoftwareName, SoftwareVersion, VulnerabilitySeverityLevel, RecommendedSecurityUpdate) by CveId
// Lookup additional vulnerability details
| lookup DeviceTvmSoftwareVulnerabilitiesKB on CveId
| where startofmonth(PublishedDate) == startofmonth(ago(8d))  // Filters for vulnerabilities published this month
// Final projection of the necessary fields
| project  VulnerabilityDescription, AffectedSoftware, CveId, VulnerabilitySeverityLevel, CvssScore, IsExploitAvailable, DesktopDeviceNameList, ServerDeviceNameList, DetailedDeviceList, PublishedDate, LastModifiedTime
